---

- block:
    - name: shell | Clone keychain repository
      git:
        repo: 'https://github.com/funtoo/keychain.git'
        dest: "{{ keychain_repo_dir }}"
        version: "{{ keychain_branch }}"
        clone: yes
      register: keychain_updated

    - name: shell | Stat keychain binary
      stat:
        path: "{{ keychain_bin }}"
      register: keychain_bin_stats

    - name: shell | Install keychain dependencies
      package:
        name: "{{ keychain_deps }}"
        state: present
      become: yes
      when: >-
        ansible_facts.packages.keys() | intersect(keychain_deps) | length != keychain_deps | length

    - name: shell | Build keychain
      make:
        chdir: "{{ keychain_repo_dir }}"
        target: all
      when: >-
        force_overwrite or keychain_updated.changed or not keychain_bin_stats.stat.exists

    - name: shell | Install keychain bin
      copy:
        src:  "{{ keychain_repo_dir + '/keychain' }}"
        dest: "{{ keychain_bin }}"
        force: yes
        mode: 0755

    - name: shell | Install keychain man
      copy:
        src:  "{{ keychain_repo_dir + '/keychain.1' }}"
        dest: "{{ user_man1_path + '/keychain.1' }}"
        force: yes
        mode: 0644

  when: install_keychain | bool
  tags:
    - keychain

- block:
    - name: shell | Clone thefuck repository
      git:
        repo: 'https://github.com/nvbn/thefuck.git'
        dest: "{{ thefuck_repo_dir }}"
        version: "{{ thefuck_branch }}"
        clone: yes
      register: thefuck_updated

    - name: shell | Install thefuck dependencies
      package:
        name: "{{ thefuck_deps }}"
        state: present
      become: yes
      when: >-
        ansible_facts.packages.keys() | intersect(thefuck_deps) | length != thefuck_deps | length

    - name: shell | Stat thefuck binary
      stat:
        path: "{{ thefuck_bin }}"
      register: thefuck_bin_stats

    - name: shell | Install thefuck
      pip:
        name: thefuck
        executable: pip3
        chdir: "{{ thefuck_repo_dir }}"
      when: >-
        force_overwrite or thefuck_updated.changed or not thefuck_bin_stats.stat.exists

  when: not dont_fuck_with_me | bool
  tags:
    - fuck

- block:
    - name: shell | Clone pass repository
      git:
        repo: 'https://git.zx2c4.com/password-store'
        dest: "{{ pass_repo_dir }}"
        version: "{{ pass_branch }}"
        clone: yes
      register: pass_updated

    - name: shell | Stat pass binary
      stat:
        path: "{{ pass_bin }}"
      register: pass_bin_stats

    - name: shell | Install pass
      make:
        chdir: "{{ pass_repo_dir }}"
        target: install
        params:
          PREFIX: "{{ user_local_path }}"
      when: force_overwrite or pass_updated.changed or not pass_bin_stats.stat.exists

  tags:
    - pass

- block:
    - name: shell | Include common .bashrc
      blockinfile:
        path:   "{{ ansible_user_dir + '/.bashrc' }}"
        backup: yes
        marker: '# {mark} desktop-config ANSIBLE MANAGED BLOCK'
        insertafter: EOF
        block: |-

            # Include common settings.
            . ~/.bashrc-common

    - name: shell | Install common bashrc
      template:
        src:    'bashrc'
        force:  yes
        backup: yes
        dest:   "{{ ansible_user_dir + '/.bashrc-common' }}"

  tags:
    - bashrc
    - keychain
    - fuck
    - pass

- name: shell | Install gpg-agent.conf
  template:
    src:    'gpg-agent.conf'
    force:  yes
    backup: yes
    dest:   "{{ ansible_user_dir + '/.gnupg/gpg-agent.conf' }}"
  notify:
    - reload gpg-agent
  tags:
    - pass

